<!DOCTYPE html>
<html lang="en">
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <style>
    /*
 * --- CORRECTIONS & ENHANCEMENTS ---
 */

/* ======== GLOBAL & BRANDING (Sharper Contrast) ======== */
:root {
    --bg-color: #000000;    /* Pure Black */
    --surface-color: #121212; /* Dark Card background */
    --primary-color: #FF0000; /* Red from your logo */
    --text-color: #FFFFFF;    /* Pure White text */
    --text-color-dark: #A0A0A0; /* Muted text */
    --secondary-yellow: #FFC300; /* For 'Pending' status */
}

/* Basic Reset */
* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

body {
    font-family: 'Roboto', sans-serif;
    background-color: var(--bg-color);
    color: var(--text-color);
    line-height: 1.6;
}

.container {
    max-width: 1200px; /* Slightly wider */
    margin: 0 auto;
    padding: 0 30px; /* Increased padding */
}

h1, h2, h3 {
    margin-bottom: 1rem;
    font-weight: 900; /* Bolder headers */
    line-height: 1.1;
}

h1 { font-size: 3.5rem; }
h2 { font-size: 2.5rem; text-align: center; margin-bottom: 3rem; }
h3 { font-size: 1.6rem; }

a { color: var(--primary-color); text-decoration: none; }

.card {
    background: var(--surface-color);
    border: none; /* Removed border for clean look */
    border-radius: 10px;
    padding: 3rem; /* Increased padding */
    box-shadow: 0 8px 25px rgba(255, 0, 0, 0.1); /* Red shadow highlight */
}

/* ======== HEADER & NAVIGATION (Corky/Modern) ======== */
.main-header {
    background: rgba(0, 0, 0, 0.9);
    backdrop-filter: blur(15px);
    border-bottom: 1px solid #1a1a1a;
    padding: 1rem 0;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    z-index: 1000;
}

.logo {
    height: 40px; /* Slightly smaller logo */
    width: auto;
}

.main-nav a {
    color: var(--text-color);
    font-weight: 700;
    text-transform: uppercase;
    font-size: 0.85rem;
    margin-left: 2rem;
    transition: all 0.2s ease;
    
    /* CORKY/UNIQUE: Subtle shear effect on hover to imply movement */
    transform: skewX(-5deg); 
    display: inline-block;
}

.main-nav a:hover {
    color: var(--primary-color);
    transform: skewX(-5deg) scale(1.05);
}


/* ======== SPA "VIEW" LOGIC (More breathing room) ======== */
main {
    padding-top: 80px; 
}

.view {
    display: none; 
    padding: 5rem 0; /* Increased vertical padding */
    animation: fadeIn 0.5s ease-in-out;
}

.view.active {
    display: block; 
}

/* ======== LANDING: HERO SECTION (Minimalist) ======== */
.hero-presentation {
    height: 100vh; 
    padding: 0;
    background-color: #000;
}

.hero-background {
    /* Removed background image for minimalist look, keeping black */
    background: linear-gradient(rgba(0,0,0,0.8), rgba(0,0,0,0.8));
}

.hero-logo {
    max-width: 300px;
    margin-bottom: 3rem;
    animation: pulse 2s infinite ease-in-out; /* Corky detail */
}

.hero-headline {
    font-size: 4.5rem; /* Massive headline */
    letter-spacing: -2px;
}

.hero-tagline {
    font-size: 1.25rem;
    font-weight: 300;
    color: var(--text-color-dark);
    max-width: 500px;
    margin: 0 auto 3rem auto;
}

.btn {
    padding: 15px 35px; /* Bigger buttons */
    border-radius: 4px; /* Sharper corners */
    letter-spacing: 1px;
}
/* ======== HOME: BOOKING FORM (Minimalist Form Styling) ======== */
#book-ride-form {
    max-width: 650px; /* Slightly narrower for focus */
    margin: 0 auto;
    text-align: left;
}

.form-field-group {
    position: relative;
    margin-bottom: 25px; /* Spacing for floating labels */
}

/* Style form inputs to look clean and modern */
input[type="text"],
input[type="tel"],
input[type="number"] {
    width: 100%;
    padding: 18px 10px 6px 10px; /* Space for the label to float */
    background: transparent; /* Seamless with card background */
    border: none;
    border-bottom: 2px solid #333; /* Underline style */
    border-radius: 0;
    color: var(--text-color);
    font-size: 1rem;
    transition: border-bottom-color 0.2s ease, background 0.2s ease;
}

input[type="text"]:focus,
input[type="tel"]:focus,
input[type="number"]:focus {
    outline: none;
    border-bottom-color: var(--primary-color);
    background: rgba(255, 0, 0, 0.05); /* Subtle background highlight on focus */
}

/* The Label (for the "Floating" effect) */
.form-field-group label {
    position: absolute;
    top: 50%;
    left: 10px;
    transform: translateY(-50%);
    color: var(--text-color-dark);
    font-size: 1rem;
    pointer-events: none; /* Ignore clicks */
    transition: 0.2s ease-out;
}

/* Floating effect when input is focused or has content */
input:focus + label,
input:not(:placeholder-shown) + label {
    top: 8px; /* Move up */
    font-size: 0.75rem; /* Shrink */
    color: var(--primary-color);
    transform: translateY(0);
}

/* Checkbox/Toggle Styles */
.checkbox-group {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 10px 0;
    font-size: 0.9rem;
    cursor: pointer;
}

/* Custom Checkbox/Toggle Switch (Minimalist) */
input[type="checkbox"] {
    appearance: none; /* Hide default */
    width: 20px;
    height: 20px;
    border: 2px solid #555;
    border-radius: 4px;
    position: relative;
    cursor: pointer;
    transition: border-color 0.2s ease;
}

input[type="checkbox"]:checked {
    border-color: var(--primary-color);
    background-color: var(--primary-color);
}

input[type="checkbox"]:checked::before {
    content: '✓';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: #fff;
    font-size: 14px;
    font-weight: 700;
}
/* ======== UNIQUE/CORKY VISUAL ELEMENT ======== */

.skew-divider {
    height: 60px;
    background: var(--surface-color);
    transform: skewY(-2deg); /* The unique skew effect */
    z-index: 10;
    margin: 4rem 0; /* Creates separation */
}

/* ======== ADMIN PANEL (Updated Colors) ======== */

#admin-rides-table th,
#driver-rides-table th {
    background: #0d0d0d;
    color: var(--secondary-yellow); /* Yellow for table header contrast */
}

/* Status colors for Tailwind compatibility in the JS */
.text-secondary-yellow { color: var(--secondary-yellow); }
.text-blue-500 { color: #3b82f6; }
.text-green-600 { color: #16a34a; }
.text-red-600 { color: #dc2626; }
.text-gray-500 { color: #6b7280; }

/* --- Keyframes --- */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.02); }
    100% { transform: scale(1); }
}

@media (max-width: 768px) {
    .hero-headline {
        font-size: 3rem;
    }
    .container {
        padding: 0 15px;
    }
}

    </style>
</head>

<body>
<header class="main-header">
    <div class="container">
        <a href="#landing-view" class="logo-link">
            <img src="178108cb417d8435e42aeebd79da000ccf1da2a9-1.jfif" alt="Citywide Logo" class="logo">
        </a>
        
        <nav class="main-nav">
            <a href="#landing-view">Home</a>
            <a href="#home-view">Book a Ride</a>
            <a href="#portal-view">Portal</a>
        </nav>
    </div>
</header>
<div id="loading-overlay">
    <div class="spinner"></div>
</div>

<main>
    
    <section id="landing-view" class="view hero-presentation active"> 
        <div class="hero-background">
            
        </div>

        <div class="hero-content">
            <img src="178108cb417d8435e42aeebd79da000ccf1da2a9-1.jfif" alt="Citywide Logo" class="hero-logo">
            <h1 class="hero-headline">Rapid. Reliable. Radically Local.</h1>
            <p class="hero-tagline">
                Skip the global giants. Citywide is your hyper-local transport network—moving our community forward, one smooth ride at a time.
            </p>
            <div class="hero-cta-buttons">
                <a href="#home-view" id="cta-ride-btn" class="btn btn-primary">Book Your Ride</a>
                <a href="#portal-view" id="cta-drive-btn" class="btn btn-secondary">Driver/Admin Login</a>
            </div>
            <div class="community-icons">
                <p style="font-size: 0.9rem;">Trusted by 1,500+ neighbors daily.</p>
            </div>
        </div>
    </section>

    <section id="home-view" class="view">
        <section class="hero-community">
            <div class="container">
                <h1>Connecting Our Community,</h1>
                <h1>One Ride at a Time.</h1>
                <p class="subtitle">The local advantage: drivers who know every shortcut and street in town.</p>
                <a href="#booking-section" class="btn-primary btn-scroll" style="width: auto;">Request a Ride Now</a>
            </div>
        </section>
        
        <div class="skew-divider"></div>

        <section class="community-values">
            <div class="container">
                <div class="value-item">
                    <img src="" alt="Safety Icon" class="icon">
                    <h3>ZERO Surprises</h3>
                    <p>Flat rates, transparent booking. Your safety and convenience are our top priority.</p>
                </div>
                <div class="value-item">
                    <img src="" alt="Community Icon" class="icon">
                    <h3>Hyper-Local Talent</h3>
                    <p>Our drivers are your neighbors, ensuring efficient pickups and friendly service.</p>
                </div>
                <div class="value-item">
                    <img src="" alt="Reliability Icon" class="icon">
                    <h3>Tap, Ride, Arrive.</h3>
                    <p>Book in seconds, get matched instantly. We're on duty 24/7/365.</p>
                </div>
            </div>
        </section>

        <section id="booking-section" class="booking-section-wrapper">
            <div class="container">
                <div class="card">
                    <h2>Lock In Your Ride</h2>
                   <form id="book-ride-form">
    <div class="form-grid">
        <div class="form-field-group">
            <input type="text" id="user-name" placeholder=" " required>
            <label for="user-name">Your Name</label>
        </div>
        
        <div class="form-field-group">
            <input type="tel" id="user-phone" placeholder=" " required>
            <label for="user-phone">Your Phone (Required for Contact)</label>
        </div>
        
        <div class="form-field-group">
            <input type="text" id="pickup" placeholder=" " required>
            <label for="pickup">Pickup Location (The 'Where')</label>
        </div>
        
        <div class="form-field-group">
            <input type="text" id="dropoff" placeholder=" " required>
            <label for="dropoff">Dropoff Location (The 'To')</label>
        </div>
    </div>

    <hr style="margin: 1rem 0; border-color: #1e1e1e;">

    <h3 style="font-size: 1.2rem; margin-bottom: 1.5rem; color: var(--primary-color);">Service Details</h3>
    
    <div class="form-grid details-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
        <div class="form-field-group">
            <input type="number" id="passengers" placeholder=" " min="1" max="6" value="1" required>
            <label for="passengers">Total Passengers (1-6)</label>
        </div>
        
        <label for="children" class="checkbox-group">
            <input type="checkbox" id="children"> Traveling with Children?
        </label>
        
        <label for="pets" class="checkbox-group">
            <input type="checkbox" id="pets"> Traveling with Pets?
        </label>

        <label for="luggage" class="checkbox-group">
            <input type="checkbox" id="luggage"> Excessive Luggage?
        </label>
    </div>
    
    <label for="assistanceWaiver" class="checkbox-group" style="margin-top: 1.5rem;">
        <input type="checkbox" id="assistanceWaiver"> I require physical assistance and accept the liability waiver.
    </label>
    
    <button type="submit" class="btn-primary" style="margin-top: 2rem;">Request a Citywide Driver</button>
    <div id="booking-status"></div>
</form>
                </div>
            </div>
        </section>
        
        <div class="skew-divider" style="transform: skewY(2deg);"></div>

        <section class="how-it-works">
            <div class="container">
                <h2>Our Simple Process</h2>
                <div class="steps-grid">
                    <div class="step">
                        <div class="step-number">1</div>
                        <h3>The Tap</h3>
                        <p>You tap the button. We log your request with speed and precision.</p>
                    </div>
                    <div class="step">
                        <div class="step-number">2</div>
                        <h3>The Match</h3>
                        <p>Our Admin team (or AI, someday!) assigns the closest, best-fit driver.</p>
                    </div>
                    <div class="step">
                        <div class="step-number">3</div>
                        <h3>The Journey</h3>
                        <p>Your driver calls, picks you up, and delivers you safely. Mission accomplished.</p>
                    </div>
                </div>
            </div>
        </section>
    </section>
    
    <section id="driver-panel-view" class="view">
        <div class="container admin-container">
            <h2 id="driver-welcome" style="margin-bottom: 3rem;">Welcome to the Driver Command Center.</h2>
            
            <div class="card" style="margin-bottom: 2rem; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h3>Availability Toggle</h3>
                    <p style="margin-bottom: 0;">Flip the switch when you're ready to roll.</p>
                </div>
                <div style="text-align: right;">
                    <div id="driver-status-text" style="font-size: 1.5rem;">Status: <strong>Offline</strong></div>
                    <button id="toggle-availability-btn" class="btn btn-primary" style="margin-top: 1rem; width: auto; font-size: 0.9rem;">Go On Duty</button>
                </div>
            </div>
            
            <div class="card" style="margin-top: 2rem;">
                <h3>Your Active Missions</h3>
                <div class="table-wrapper">
                    <table id="driver-rides-table">
                        <thead></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>
    
    <section id="admin-panel-view" class="view">
    <div class="container admin-container">
        <h2>Admin Operations Center</h2>
        
        <div class="card">
            <h3>All Live Ride Requests</h3>
            <p>Monitor, assign, and manage all active citywide transport requests.</p>
            <div class="table-wrapper">
                <table id="admin-rides-table">
                    <thead></thead>
                    <tbody></tbody>
                </table>
            </div>
            <div id="admin-status" class="mt-4 text-center"></div> 
        </div>
    </div>
</section>
    
    <section id="portal-view" class="view auth-page">
        <div class="container admin-container">
            <div id="gsi-invisible-prompt" style="display: none;"></div>
            <h2>Portal Access Required</h2>
            <p class="hero-tagline">Securely log in with your official Citywide email via Google.</p>
            
            <div id="gsi-button-container" style="margin-top: 20px;">
                </div>

            <div id="login-status" style="margin-top: 15px; font-weight: bold;"></div>
            
            <button onclick="logout()" id="logout-button-container" class="btn btn-secondary" style="margin-top: 30px; width: auto; display: none;">
                Logout
            </button>
        </div>
    </section>
    
</main>

    
    <!-- Google Sign-In SDK (Necessary for the portal login) -->
  <script type="module">
    // --- Global Variables ---
// CRITICAL: Ensure this is your latest, published Apps Script URL
const APP_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyyIBp_A4nezssn33cm2oNHNaGftrvv5F5QvSjslZSTkL9u1BpfIVmdkQxhoRqYg6HFkg/exec'; 
let currentUserEmail = null;
let userRole = 'guest'; // 'guest', 'rider', 'driver', 'admin'
let availableDrivers = []; // To store drivers fetched for admin panel

// --- Utility Functions ---

/** Shows the loading spinner overlay. */
function showLoading() {
    document.getElementById('loading-overlay').style.display = 'flex';
}

/** Hides the loading spinner overlay. */
function hideLoading() {
    document.getElementById('loading-overlay').style.display = 'none';
}

/** Displays a status message to the user. */
function showMessage(elementId, message, isError = false) {
    const el = document.getElementById(elementId);
    if (!el) return;
    el.textContent = message;
    
    // Using Tailwind CSS classes for visual feedback
    el.className = isError 
        ? 'mt-4 text-center font-bold text-red-600' 
        : 'mt-4 text-center font-bold text-green-600';
        
    if (!isError) {
        setTimeout(() => el.textContent = '', 5000);
    }
}

/** Basic Hash-based Router */
function router() {
    const hash = window.location.hash || '#landing-view';
    const views = document.querySelectorAll('.view');
    views.forEach(view => view.classList.remove('active'));

    const targetView = document.querySelector(hash);
    if (targetView) {
        targetView.classList.add('active');
        window.scrollTo(0, 0);

        // Security Check: Deny direct access if role is wrong
        if (hash === '#driver-panel-view' && userRole !== 'driver') {
            window.location.hash = '#portal-view';
            showMessage('login-status', 'Access Denied. Please sign in as a driver.', true);
        } else if (hash === '#admin-panel-view' && userRole !== 'admin') {
            window.location.hash = '#portal-view';
            showMessage('login-status', 'Access Denied. Please sign in as an admin.', true);
        }
    } else {
        window.location.hash = '#landing-view'; // Fallback
    }
}

// --- CORE AUTHENTICATION AND INITIALIZATION LOGIC ---

/**
 * Sends a GET request to Apps Script to securely check the user's role.
 * @returns {string} The determined role ('admin', 'driver', or 'guest').
 */
async function checkUserAuthentication() {
    showLoading();
    try {
        // Calls the secure endpoint in Apps Script (which uses Session.getActiveUser().getEmail())
        const response = await fetch(APP_SCRIPT_URL + '?action=checkAuth'); 
        const result = await response.json();

        if (result.status === 'success' && result.userEmail) {
            currentUserEmail = result.userEmail;
            userRole = result.role;
            
            // Update UI
            const statusEl = document.getElementById('login-status');
            if (statusEl) {
                statusEl.textContent = `Signed in as: ${currentUserEmail} (${userRole.toUpperCase()})`;
            }

            const logoutBtnContainer = document.getElementById('logout-button-container');
            const gsiContainer = document.getElementById('gsi-button-container');
            if (logoutBtnContainer && gsiContainer) {
                logoutBtnContainer.style.display = 'inline-block';
                gsiContainer.style.display = 'none';
            }
            
            const driverWelcomeEl = document.getElementById('driver-welcome');
            if (userRole === 'driver' && driverWelcomeEl) {
                 driverWelcomeEl.textContent = `Welcome, Driver ${currentUserEmail.split('@')[0]}!`;
            }
            
            return userRole;
        } else {
            currentUserEmail = null;
            userRole = 'guest';
            return 'guest'; 
        }

    } catch (error) {
        console.error("Authentication Error:", error);
        showMessage('main-status', `Authentication failed. Please ensure you are logged in: ${error.message}`, true);
        currentUserEmail = null;
        userRole = 'guest';
        return 'guest';
    } finally {
        hideLoading();
    }
}

/** * Initializes the application flow: check role, set view, load data. */
async function initializeApp() {
    // 1. Setup GSI button 
    if (window.google && document.getElementById('gsi-button-container')) {
        window.google.accounts.id.initialize({
            client_id: '290258312369-dvtidrarb7kosrqipq45t1ueqrf23hsm.apps.googleusercontent.com', 
            callback: handleCredentialResponse, 
            auto_select: false,
            context: 'signin',
            ux_mode: 'popup'
        });
        window.google.accounts.id.renderButton(
            document.getElementById('gsi-button-container'),
            { theme: "outline", size: "large", type: "standard", shape: "pill", width: "300" }
        );
    }
    
    // 2. Check the user's actual role via Apps Script
    const role = await checkUserAuthentication();

    // 3. Navigate and load data based on the secure role check
    if (role === 'admin') {
        window.location.hash = '#admin-panel-view';
        await fetchAdminDashboard(); 
        await fetchAvailableDrivers(); 
    } else if (role === 'driver') {
        window.location.hash = '#driver-panel-view';
        await fetchDriverRides();
        // Optional: Run function to check/set initial driver status display
        // await checkDriverStatus(); 
    } else {
        window.location.hash = '#landing-view';
    }
    
    // 4. Force router to apply the view 
    router(); 
}

/** GSI Callback: We only use this to trigger the main Apps Script role check. */
async function handleCredentialResponse(response) {
    showLoading();
    try {
        // Re-run initialization after GSI succeeds
        await initializeApp(); 
    } catch (error) {
        console.error("Google Sign-In failed during initialization:", error);
        showMessage('login-status', 'Login failed. Please try again.', true);
    } finally {
        hideLoading();
    }
}

/** Logs the user out. */
window.logout = async function() {
    currentUserEmail = null;
    userRole = 'guest';
    
    // Force Google to log out
    if (window.google && window.google.accounts && window.google.accounts.id) {
        window.google.accounts.id.disableAutoSelect();
    }
    
    // Reset UI and reload app state
    const statusEl = document.getElementById('login-status');
    if (statusEl) statusEl.textContent = 'Please sign in to access the portal.';
    document.getElementById('logout-button-container').style.display = 'none';
    document.getElementById('gsi-button-container').style.display = 'flex';
    
    window.location.hash = '#portal-view';
    initializeApp(); 
};


// --- Apps Script Integration Functions (Data Fetching) ---

/** * Fetches ALL rides for the Admin Dashboard. */
async function fetchAdminDashboard() {
    if (userRole !== 'admin') return; 
    showLoading();
    showMessage('admin-status', 'Loading all ride data...', false);
    try {
        const response = await fetch(APP_SCRIPT_URL + '?action=getAdminDashboard');
        const result = await response.json();

        if (result.status === 'success') {
            renderAdminRides(result.data); // Pass data to rendering function
            showMessage('admin-status', `Successfully loaded ${result.data.length - 1} total rides.`, false);
        } else {
            throw new Error(result.message || "Failed to fetch admin dashboard data.");
        }
    } catch (error) {
        console.error("Error fetching admin dashboard:", error);
        showMessage('admin-status', `Error loading dashboard: ${error.message}.`, true);
    } finally {
        hideLoading();
    }
}

/** * Fetches the list of available drivers for assignment purposes. */
async function fetchAvailableDrivers() {
    if (userRole !== 'admin') return; 
    try {
        const response = await fetch(APP_SCRIPT_URL + '?action=getAvailableDrivers');
        const result = await response.json();

        if (result.status === 'success') {
            availableDrivers = result.drivers; // Store globally for use in rendering
            renderAvailableDrivers(availableDrivers); 
            console.log(`Available Drivers: ${availableDrivers.length}`);
        } else {
            throw new Error(result.message || "Failed to fetch available drivers.");
        }
    } catch (error) {
        console.error("Error fetching available drivers:", error);
    }
}

/** * Fetches assigned rides for the current driver. */
async function fetchDriverRides() { 
    if (userRole !== 'driver') return; 
    showLoading();
    try {
        const response = await fetch(APP_SCRIPT_URL + '?action=GET_DRIVER_RIDES'); 
        const result = await response.json();

        if (result.status === 'success') {
            renderDriverRides(result.rides); 
            showMessage('driver-status', `Found ${result.rides.length} assigned rides.`, false);
        } else {
            throw new Error(result.message || "Failed to fetch driver rides.");
        }
    } catch (error) {
        console.error("Error fetching driver rides:", error);
        showMessage('driver-status', `Error loading rides: ${error.message}.`, true);
    } finally {
        hideLoading();
    }
}

// --- Driver Status Placeholder (For eventual implementation) ---
async function checkDriverStatus() {
    if (userRole !== 'driver') return;
    const toggleButton = document.getElementById('toggle-availability-btn');
    if (toggleButton) {
        // Assume online if logged in until we have a dedicated GET endpoint
        toggleButton.textContent = 'Go Offline';
        toggleButton.classList.add('bg-green-500'); 
        toggleButton.classList.remove('bg-red-500');
    }
}


// --- POST Actions (Unchanged, rely on server-side security) ---
// --- POST Actions (Requires corresponding server-side implementation) ---

/** Replaces Firebase 'bookRide' by sending data to Google Apps Script. */
async function bookRide(event) {
    event.preventDefault();
    showLoading();
    const form = event.target;
    
    // Collect data from the booking form
    const rideData = {
        action: 'BOOK_RIDE',
        name: form['user-name'].value.trim(),
        phone: form['user-phone'].value.trim(),
        pickup: form['pickup'].value.trim(),
        dropoff: form['dropoff'].value.trim(),
        passengers: parseInt(form['passengers'].value, 10),
        
        children: form['children'].checked,
        pets: form['pets'].checked,
        luggage: form['luggage'].checked,
        assistanceWaiver: form['assistanceWaiver'].checked,
    };

    try {
        if (!APP_SCRIPT_URL.startsWith('http')) {
            throw new Error("Apps Script URL not set. Cannot submit.");
        }
        
        const response = await fetch(APP_SCRIPT_URL, {
            method: 'POST',
            mode: 'cors', 
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(rideData)
        });

        if (!response.ok) {
            const errorResult = await response.json().catch(() => ({ status: 'error', message: `HTTP Error ${response.status}` }));
            throw new Error(errorResult.message || `Request failed with status ${response.status}`);
        }

        const result = await response.json();

        if (result.status === 'success') {
            form.reset();
            showMessage('booking-status', `Ride requested successfully! Status: ${result.initialStatus}.`, false);
        } else {
            throw new Error(result.message || "Unknown error during booking.");
        }
        
    } catch (error) {
        console.error("Error booking ride via Apps Script:", error);
        showMessage('booking-status', `Error submitting request: ${error.message}.`, true);
    } finally {
        hideLoading();
    }
}

/** * Sends a POST request to Apps Script to toggle the driver's availability status. */
window.toggleAvailability = async function() {
    if (userRole !== 'driver') {
        showMessage('driver-status', 'Access Denied. You are not signed in as a driver.', true);
        return;
    }
    showLoading();

    const payload = {
        action: 'TOGGLE_DRIVER_STATUS',
        driverEmail: currentUserEmail
    };

    try {
        const response = await fetch(APP_SCRIPT_URL, {
            method: 'POST',
            mode: 'cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            const errorResult = await response.json().catch(() => ({ message: `HTTP Error ${response.status}` }));
            throw new Error(errorResult.message || `Request failed with status ${response.status}`);
        }

        const result = await response.json();
        
        if (result.status === 'success') {
            const statusText = result.isAvailable ? 'ONLINE' : 'OFFLINE';
            showMessage('driver-status', `You are now ${statusText}.`, false);
            
            const toggleButton = document.getElementById('toggle-availability-btn');
            if (toggleButton) {
                toggleButton.textContent = result.isAvailable ? 'Go Offline' : 'Go Online';
                toggleButton.classList.toggle('bg-red-500', !result.isAvailable);
                toggleButton.classList.toggle('bg-green-500', result.isAvailable);
            }
        } else {
            throw new Error(result.message || "Unknown error during status update.");
        }

    } catch (error) {
        console.error("Error toggling availability:", error);
        showMessage('driver-status', `Status update failed: ${error.message}.`, true);
    } finally {
        hideLoading();
    }
};

/** * Sends a POST request to Apps Script to assign a ride to a specific driver. */
window.assignRideToDriver = async function(rideId, driverId, driverEmail) {
    if (userRole !== 'admin') {
        showMessage('admin-status', 'Permission denied for this action.', true);
        return;
    }
    showLoading();
    
    const payload = {
        action: 'ASSIGN_RIDE', 
        rideId: rideId,
        driverEmail: driverEmail
    };

    try {
        const response = await fetch(APP_SCRIPT_URL, {
            method: 'POST',
            mode: 'cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            const errorResult = await response.json().catch(() => ({ message: `HTTP Error ${response.status}` }));
            throw new Error(errorResult.message || `Request failed with status ${response.status}`);
        }

        const result = await response.json();

        if (result.status === 'success') {
            showMessage('admin-status', `Successfully assigned Ride ${rideId.substring(0, 4)}... to ${driverEmail.split('@')[0]}.`, false);
            
            await fetchAdminDashboard(); 
            
        } else {
            throw new Error(result.message || "Unknown error during assignment.");
        }

    } catch (error) {
        console.error("Error assigning ride:", error);
        showMessage('admin-status', `Assignment failed: ${error.message}.`, true);
    } finally {
        hideLoading();
    }
};

/** * Sends a POST request to Apps Script to update a ride status (for drivers). */
window.updateRideStatus = async function(rideId, newStatus) {
    if (userRole !== 'driver') {
        showMessage('driver-status', 'Permission denied for this action.', true);
        return;
    }
    showLoading();
    
    const payload = {
        action: 'UPDATE_RIDE_STATUS', 
        rideId: rideId,
        newStatus: newStatus
    };

    try {
        const response = await fetch(APP_SCRIPT_URL, {
            method: 'POST',
            mode: 'cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            const errorResult = await response.json().catch(() => ({ message: `HTTP Error ${response.status}` }));
            throw new Error(errorResult.message || `Request failed with status ${response.status}`);
        }

        const result = await response.json();

        if (result.status === 'success') {
            showMessage('driver-status', `Ride ${rideId.substring(0, 4)}... status updated to ${newStatus}!`, false);
            await fetchDriverRides();
        } else {
            throw new Error(result.message || "Unknown error during status update.");
        }

    } catch (error) {
        console.error("Error updating ride status:", error);
        showMessage('driver-status', `Status update failed: ${error.message}.`, true);
    } finally {
        hideLoading();
    }
};

// --- UI RENDERING FUNCTIONS ---

/**
 * Creates the HTML for the driver assignment dropdown.
 */
function createDriverDropdown(rideId) {
    if (availableDrivers.length === 0) {
        return '<select disabled class="p-2 bg-gray-100"><option>No Drivers Online</option></select>';
    }

    let options = '<select id="driver-select-' + rideId + '" class="p-2 border rounded text-sm">';
    options += '<option value="">--- Select Driver ---</option>';

    availableDrivers.forEach(driver => {
        const displayName = driver.name || driver.email.split('@')[0];
        options += `<option value="${driver.email}">${displayName} (${driver.email.split('@')[0]})</option>`;
    });

    options += '</select>';
    return options;
}

/**
 * Renders the Admin Rides table.
 */
function renderAdminRides(data) {
    const tbody = document.querySelector('#admin-rides-table tbody');
    if (!tbody) return;
    tbody.innerHTML = ''; 
    const rideRows = data.slice(1); 
    if (rideRows.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4">No ride requests found.</td></tr>';
        return;
    }
    
    // Sort: Pending first, then by Time (oldest first)
    rideRows.sort((a, b) => {
        const statusA = a[7]; 
        const statusB = b[7];
        const timeA = new Date(a[1]).getTime(); 
        const timeB = new Date(b[1]).getTime();

        if (statusA === 'Pending' && statusB !== 'Pending') return -1;
        if (statusA !== 'Pending' && statusB === 'Pending') return 1;
        return timeA - timeB; 
    });


    rideRows.forEach(row => {
        // Indices: 0: ID, 1: Time, 2: Name, 3: Phone, 4: Pickup, 5: Dropoff, 6: Assigned, 7: Status
        const [rideId, time, name, phone, pickup, dropoff, assignedDriver, status] = row;
        const rideTime = new Date(time);
        const statusClass = getRideStatusColor(status);
        const driverName = assignedDriver === 'Unassigned' ? '—' : assignedDriver.split('@')[0];
        
        let actionCellContent;
        if (status === 'Pending' || status === 'Unassigned') {
            const driverDropdown = createDriverDropdown(rideId);
            const buttonDisabled = availableDrivers.length === 0 ? 'disabled' : '';

            actionCellContent = `
                <div class="flex flex-col space-y-2 items-center">
                    ${driverDropdown}
                    <button onclick="handleAdminAssignment('${rideId}')" 
                            ${buttonDisabled}
                            class="w-full text-sm font-semibold p-2 rounded 
                                ${buttonDisabled ? 'bg-gray-400' : 'bg-blue-500 hover:bg-blue-600 text-white'}">
                        Assign
                    </button>
                </div>
            `;
        } else {
            actionCellContent = `<span class="px-2 py-1 rounded ${statusClass} font-semibold">${status}</span>`;
        }

        const rowHTML = `
            <tr class="border-b hover:bg-gray-50">
                <td class="p-3 text-xs font-mono">${rideId.substring(0, 4)}...</td>
                <td class="p-3 text-sm">${rideTime.toLocaleTimeString()} (${rideTime.toLocaleDateString()})</td>
                <td class="p-3 text-sm font-semibold">${name} (<a href="tel:${phone}" class="text-blue-500">${phone}</a>)</td>
                <td class="p-3 text-sm">${pickup} to ${dropoff}</td>
                <td class="p-3 text-sm">${driverName}</td>
                <td class="p-3 text-center">
                    ${actionCellContent}
                </td>
                <td class="p-3 text-center">
                     <button onclick="window.showRideDetails('${rideId}', ${JSON.stringify(row)})" class="text-xs text-indigo-500 hover:text-indigo-700">Details</button>
                </td>
            </tr>
        `;
        tbody.innerHTML += rowHTML;
    });
}

/**
 * Placeholder function for driver list rendering (admin).
 */
function renderAvailableDrivers(drivers) {
    const driverCountEl = document.getElementById('available-driver-count');
    if(driverCountEl) {
        driverCountEl.textContent = drivers.length;
    }
}

/**
 * Renders the Driver Rides table.
 */
function renderDriverRides(rides) {
    const tbody = document.querySelector('#driver-rides-table tbody');
    if (!tbody) return;
    tbody.innerHTML = ''; 

    if (!rides || rides.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4">No assigned rides currently.</td></tr>';
        return;
    }

    rides.forEach(row => {
        // Indices: 0: ID, 1: Time, 2: Name, 3: Phone, 4: Pickup, 5: Dropoff, 6: Assigned, 7: Status
        const [rideId, time, name, phone, pickup, dropoff, , status] = row; 
        const rideTime = new Date(time);
        const statusClass = getRideStatusColor(status);
        
        let actionButton;
        if (status === 'Assigned') {
            actionButton = `<button onclick="window.updateRideStatus('${rideId}', 'Picked Up')" class="text-xs font-semibold p-2 rounded bg-indigo-500 hover:bg-indigo-600 text-white">Picked Up</button>`;
        } else if (status === 'Picked Up') {
            actionButton = `<button onclick="window.updateRideStatus('${rideId}', 'Completed')" class="text-xs font-semibold p-2 rounded bg-green-500 hover:bg-green-600 text-white">Drop Off</button>`;
        } else {
            actionButton = `<span class="px-2 py-1 rounded ${statusClass} text-xs font-semibold">${status}</span>`;
        }

        const rowHTML = `
            <tr class="border-b hover:bg-gray-50">
                <td class="p-3 text-sm">${rideTime.toLocaleTimeString()} (${rideTime.toLocaleDateString()})</td>
                <td class="p-3 text-sm font-semibold">${name} (<a href="tel:${phone}" class="text-blue-500">${phone}</a>)</td>
                <td class="p-3 text-sm">${pickup} to ${dropoff}</td>
                <td class="p-3 text-center">
                    ${actionButton}
                </td>
                <td class="p-3 text-center">
                    <button onclick="window.showRideDetails('${rideId}', ${JSON.stringify(row)})" class="text-xs text-indigo-500 hover:text-indigo-700">Details</button>
                </td>
            </tr>
        `;
        tbody.innerHTML += rowHTML;
    });
}

// Helper for status colors (Updated to include background classes)
function getRideStatusColor(status) { 
    if (status.includes('Canceled')) return 'text-gray-700 bg-gray-100';
    if (status.includes('Completed')) return 'text-green-700 bg-green-100';
    if (status.includes('Picked Up')) return 'text-indigo-700 bg-indigo-100';
    if (status.includes('Assigned')) return 'text-blue-700 bg-blue-100';
    return 'text-yellow-700 bg-yellow-100';
}


// --- ADMIN ACTION HANDLERS ---
// (These are wrappers that grab the data from the UI before calling the POST functions)

/** Handles the button click to assign a ride after selecting a driver from the dropdown. */
window.handleAdminAssignment = function(rideId) {
    const selectElement = document.getElementById('driver-select-' + rideId);
    const driverEmail = selectElement ? selectElement.value : '';

    if (!driverEmail) {
        showMessage('admin-status', `Please select a driver for Ride ${rideId.substring(0, 4)}...`, true);
        return;
    }
    window.assignRideToDriver(rideId, driverEmail, driverEmail);
}

/** Placeholder function to show full ride details in a modal or side panel. */
window.showRideDetails = function(rideId, rideData) {
    console.log("Showing details for Ride:", rideId, rideData);
    const details = `
        ID: ${rideData[0]} | Time: ${new Date(rideData[1]).toLocaleString()}
        Customer: ${rideData[2]} (${rideData[3]})
        From: ${rideData[4]} | To: ${rideData[5]}
        Assigned: ${rideData[6] === 'Unassigned' ? 'None' : rideData[6].split('@')[0]} | Status: ${rideData[7]}
        Extras: P: ${rideData[8] || 'N/A'}, C: ${rideData[9] || 'N/A'}, Pets: ${rideData[10] || 'N/A'}, Luggage: ${rideData[11] || 'N/A'}
    `;
    showMessage('admin-status', details.replace(/\n/g, '<br>'), false);
};
// --- Initialization and Event Listeners ---

// 1. Router setup
window.addEventListener('hashchange', router);

// 2. Form submission for ride booking (Assuming this is already linked in your HTML)
document.getElementById('book-ride-form')?.addEventListener('submit', bookRide);

// 3. App start (MUST be the last line executed outside of functions)
window.onload = initializeApp;
  </script>

</body>
</html>
