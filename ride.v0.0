<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CityWide Logistics Dispatch</title>
    <!-- Load Tailwind CSS from CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --primary-color: #3b82f6; /* Blue-500 */
            --secondary-color: #10b981; /* Emerald-500 */
            --danger-color: #ef4444; /* Red-500 */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        .container {
            max-width: 480px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background-color: var(--primary-color);
            transition: transform 0.1s, opacity 0.1s;
        }
        .btn-primary:hover {
            background-color: #2563eb; /* Blue-600 */
            transform: translateY(-1px);
        }
        .btn-secondary {
            background-color: var(--secondary-color);
            transition: transform 0.1s, opacity 0.1s;
        }
        .btn-secondary:hover {
            background-color: #059669; /* Emerald-600 */
            transform: translateY(-1px);
        }
        .tab-button.active {
            border-bottom: 3px solid var(--primary-color);
            color: var(--primary-color);
            font-weight: 600;
        }
        /* Custom spinner for loading state */
        .spinner {
            border-top-color: #fff;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }
        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 flex justify-center min-h-screen">

    <div id="app" class="container bg-white rounded-xl h-full flex flex-col overflow-hidden">
        
        <!-- Header -->
        <header class="bg-gray-800 p-4 text-white flex justify-between items-center rounded-t-xl">
            <h1 class="text-xl font-bold tracking-wide">CityWide Dispatch</h1>
            <button id="settingsButton" class="p-1 rounded-full hover:bg-gray-700 transition">
                <!-- Settings Icon SVG -->
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.44a2 2 0 0 0-2 2h-.44a2 2 0 0 0-2 2v.44a2 2 0 0 0-2 2v.44a2 2 0 0 0 2 2h.44a2 2 0 0 0 2 2v.44a2 2 0 0 0 2 2h.44a2 2 0 0 0 2 2v.44a2 2 0 0 0 2 2h.44a2 2 0 0 0 2 2v.44a2 2 0 0 0 2 2h.44a2 2 0 0 0 2 2v.44a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.44a2 2 0 0 0 2-2h.44a2 2 0 0 0 2-2v-.44a2 2 0 0 0 2-2h.44a2 2 0 0 0 2-2v-.44a2 2 0 0 0 2-2v-.44a2 2 0 0 0 2-2h.44a2 2 0 0 0-2-2v-.44a2 2 0 0 0-2-2h-.44a2 2 0 0 0-2-2v-.44a2 2 0 0 0-2-2h-.44a2 2 0 0 0-2-2v-.44a2 2 0 0 0-2-2zM12 16a4 4 0 1 0 0-8 4 4 0 0 0 0 8z"/></svg>
            </button>
        </header>

        <!-- Main Navigation Tabs -->
        <nav id="mainTabs" class="flex border-b bg-white">
            <!-- Tabs will be generated here -->
        </nav>

        <!-- Notification/Error Message Area -->
        <div id="messageContainer" class="p-3">
            <div id="statusMessage" class="hidden text-sm p-3 rounded-lg font-medium"></div>
            <div id="errorMessage" class="hidden text-sm p-3 rounded-lg font-medium bg-red-100 text-red-700"></div>
        </div>

        <!-- Main Content Area -->
        <main id="contentArea" class="flex-grow p-4 overflow-y-auto">
            <div id="loadingIndicator" class="text-center text-gray-500 py-10 hidden">
                <div class="spinner border-4 border-gray-300 h-10 w-10 rounded-full mx-auto mb-3" role="status"></div>
                <p>Loading data...</p>
            </div>
            
            <!-- Home View (Booking Form) -->
            <div id="home-view" class="view">
                <h2 class="text-2xl font-semibold mb-4 text-gray-700">Book a New Ride</h2>
                <form id="bookingForm" class="space-y-4 bg-gray-50 p-6 rounded-lg shadow-inner">
                    <input type="text" id="name" placeholder="Your Name" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <input type="tel" id="phone" placeholder="Contact Phone" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <input type="text" id="pickup" placeholder="Pickup Location (e.g., Address, Landmark)" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <input type="text" id="destination" placeholder="Destination Location" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <textarea id="notes" placeholder="Delivery/Ride Notes (e.g., large luggage, time constraints)" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></textarea>
                    
                    <button type="submit" class="btn-primary w-full text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:shadow-lg flex items-center justify-center">
                        <!-- PlusCircle Icon SVG -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-2"><circle cx="12" cy="12" r="10"/><path d="M12 8v8"/><path d="M8 12h8"/></svg>
                        Submit Booking
                    </button>
                </form>
            </div>

            <!-- Driver View -->
            <div id="driver-view" class="view hidden">
                <h2 class="text-2xl font-semibold mb-4 text-gray-700">Your Assigned Rides</h2>
                <div id="driverRidesList" class="space-y-4">
                    <p class="text-center text-gray-500 p-4 border rounded-lg">No assigned rides currently. Check back soon!</p>
                </div>
            </div>

            <!-- Admin View -->
            <div id="admin-view" class="view hidden">
                <h2 class="text-2xl font-semibold mb-4 text-gray-700">Dispatch Panel</h2>

                <h3 class="text-xl font-medium mb-3 text-gray-600">Pending Bookings</h3>
                <div id="pendingBookingsList" class="space-y-4 mb-8">
                    <p class="text-center text-gray-500 p-4 border rounded-lg">No new bookings requiring assignment.</p>
                </div>

                <h3 class="text-xl font-medium mb-3 text-gray-600">Active Drivers</h3>
                <select id="driverSelector" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                    <option value="" disabled selected>Select a Driver</option>
                    <!-- Driver options will be populated here -->
                </select>
            </div>

            <!-- Settings View (The one that was opened by the user) -->
            <div id="settings-view" class="view hidden">
                <h2 class="text-2xl font-semibold mb-4 text-gray-700">Settings</h2>
                <div class="space-y-4 bg-gray-50 p-6 rounded-lg shadow-inner">
                    <p class="text-lg font-medium text-gray-600 mb-2">Select Your Role</p>
                    <select id="roleSelector" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <option value="public">Public User (Booker)</option>
                        <option value="driver">Driver</option>
                        <option value="admin">Admin / Dispatch</option>
                    </select>
                    
                    <p class="text-lg font-medium text-gray-600 mt-6 mb-2">Deployment Status</p>
                    <p class="text-sm text-gray-500">Make sure this URL is correct to enable communication with Google Sheets.</p>
                    <input type="text" id="scriptUrlInput" placeholder="Your Apps Script URL" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" readonly>
                    
                    <button id="saveSettingsButton" class="btn-primary w-full text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:shadow-lg">
                        Save Role
                    </button>
                </div>
            </div>

        </main>
    </div>

    <script>
        // --- CONFIGURATION ---
        // *** REPLACE THIS PLACEHOLDER URL WITH YOUR DEPLOYED GOOGLE APPS SCRIPT URL ***
        // THIS IS THE MOST LIKELY REASON FOR CONNECTION FAILURE.
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyyIBp_A4nezssn33cm2oNHNaGftrvv5F5QvSjslZSTkL9u1BpfIVmdkQxhoRqYg6HFkg/exec"; 
        // Example Driver IDs (use this for testing the Admin Assign function)
        const MOCK_DRIVERS = [
            { id: "D-001", name: "Alice Johnson" },
            { id: "D-002", name: "Bob Smith" },
            { id: "D-003", name: "Charlie Brown" }
        ];

        // --- GLOBAL STATE & DOM ELEMENTS ---
        const app = document.getElementById('app');
        const contentArea = document.getElementById('contentArea');
        const mainTabs = document.getElementById('mainTabs');
        const roleSelector = document.getElementById('roleSelector');
        const scriptUrlInput = document.getElementById('scriptUrlInput');
        const settingsButton = document.getElementById('settingsButton');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const statusMessage = document.getElementById('statusMessage');
        const errorMessage = document.getElementById('errorMessage');
        const driverSelector = document.getElementById('driverSelector');
        const driverRidesList = document.getElementById('driverRidesList');
        const pendingBookingsList = document.getElementById('pendingBookingsList');

        let currentRole = localStorage.getItem('userRole') || 'public';
        let currentView = 'home-view';
        let pendingBookings = [];
        let activeDriverId = MOCK_DRIVERS[0].id; // Default driver for Admin assignment

        // --- ICON LIBRARY (Embedded SVGs to fix Tracking Prevention) ---
        const SVG_ICONS = {
            'home': '<path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/>',
            'plus-circle': '<circle cx="12" cy="12" r="10"/><path d="M12 8v8"/><path d="M8 12h8"/>',
            'list-checks': '<path d="m3 16 2 2 2-2"/><path d="M7 16h14"/><path d="m3 11 2 2 2-2"/><path d="M7 11h14"/><path d="m3 6 2 2 2-2"/><path d="M7 6h14"/>',
            'car': '<path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.6-.4-1-1-1h-1a2 2 0 0 0-2 2v2a2 2 0 0 1-2 2l-1 1h-6"/><path d="M10 17H5c-.6 0-1-.4-1-1v-3c0-.6.4-1 1-1h12a2 2 0 0 1 2 2v2a2 2 0 0 0 2 2h2"/><circle cx="7" cy="18" r="2"/><path d="M18 10h-1m-10 7h-1"/><path d="M10 17H5c-.6 0-1-.4-1-1v-3c0-.6.4-1 1-1h12a2 2 0 0 1 2 2v2a2 2 0 0 0 2 2h2"/>',
            'user': '<path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>',
            'settings': '<path d="M12.22 2h-.44a2 2 0 0 0-2 2v.44a2 2 0 0 0-2 2h-.44a2 2 0 0 0-2 2v.44a2 2 0 0 0-2 2v.44a2 2 0 0 0 2 2h.44a2 2 0 0 0 2 2v.44a2 2 0 0 0 2 2h.44a2 2 0 0 0 2 2v.44a2 2 0 0 0 2 2h.44a2 2 0 0 0 2 2v.44a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.44a2 2 0 0 0 2-2h.44a2 2 0 0 0 2-2v-.44a2 2 0 0 0 2-2v-.44a2 2 0 0 0 2-2h.44a2 2 0 0 0-2-2v-.44a2 2 0 0 0-2-2h-.44a2 2 0 0 0-2-2v-.44a2 2 0 0 0-2-2h-.44a2 2 0 0 0-2-2v-.44a2 2 0 0 0-2-2zM12 16a4 4 0 1 0 0-8 4 4 0 0 0 0 8z"/>',
            'chevron-right': '<path d="m9 18 6-6-6-6"/>',
            'x': '<path d="M18 6 6 18"/><path d="m6 6 12 12"/>',
            'loader-circle': '<path d="M21 12a9 9 0 1 1-6.219-8.56"/>'
        };

        const renderIcon = (name, className = 'w-5 h-5') => {
            const path = SVG_ICONS[name.toLowerCase()] || '';
            return `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${className}">${path}</svg>`;
        };

        // --- UTILITY FUNCTIONS ---

        /** Shows a temporary status message (success/info) */
        const displayStatus = (message, isError = false) => {
            // Safety check
            if (!statusMessage || !errorMessage) return;

            statusMessage.textContent = message;
            statusMessage.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');

            if (isError) {
                statusMessage.classList.add('bg-red-100', 'text-red-700');
            } else {
                statusMessage.classList.add('bg-green-100', 'text-green-700');
            }
            statusMessage.classList.remove('hidden');

            setTimeout(() => {
                statusMessage.classList.add('hidden');
            }, 5000);
        };

        /** Shows a persistent error message */
        const displayError = (message) => {
            if (errorMessage) {
                errorMessage.innerHTML = `${renderIcon('x', 'w-5 h-5 inline mr-2')}${message}`;
                errorMessage.classList.remove('hidden');
            }
        };

        /** Clears the persistent error message */
        const clearError = () => {
            if (errorMessage) {
                errorMessage.classList.add('hidden');
                errorMessage.textContent = '';
            }
        };

        /** Shows/hides the main loading indicator */
        const toggleLoading = (show) => {
            if (loadingIndicator) {
                loadingIndicator.classList.toggle('hidden', !show);
                contentArea.classList.toggle('opacity-50', show);
                contentArea.classList.toggle('pointer-events-none', show);
            }
        };

        // --- NAVIGATION & ROLE HANDLING ---

        /** Updates the visibility of views based on the selected role and current view */
        const updateView = (viewId = currentView) => {
            currentView = viewId;
            document.querySelectorAll('.view').forEach(view => {
                view.classList.add('hidden');
            });
            const targetView = document.getElementById(viewId);
            if (targetView) {
                targetView.classList.remove('hidden');
            }
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            const activeButton = document.querySelector(`.tab-button[data-view-id="${viewId}"]`);
            if (activeButton) {
                activeButton.classList.add('active');
            }
            // If we switch to a data-driven view, trigger a refresh
            if (currentRole === 'driver' && viewId === 'driver-view') {
                fetchDriverRides();
            }
            if (currentRole === 'admin' && viewId === 'admin-view') {
                fetchPendingBookings();
            }
        };

        /** Sets up the navigation tabs based on the current role */
        const setupTabs = () => {
            const tabs = {
                'public': [
                    { id: 'home-view', label: 'Book Ride', icon: 'home' }
                ],
                'driver': [
                    { id: 'driver-view', label: 'My Rides', icon: 'car' }
                ],
                'admin': [
                    { id: 'admin-view', label: 'Dispatch', icon: 'list-checks' }
                ]
            };

            const roleTabs = tabs[currentRole] || tabs['public'];
            mainTabs.innerHTML = '';

            roleTabs.forEach(tab => {
                const button = document.createElement('button');
                button.className = `tab-button flex-1 p-3 text-center transition text-gray-600 flex items-center justify-center`;
                button.setAttribute('data-view-id', tab.id);
                button.innerHTML = `${renderIcon(tab.icon, 'w-5 h-5 mr-2')} ${tab.label}`;
                button.addEventListener('click', () => updateView(tab.id));
                mainTabs.appendChild(button);
            });
            
            // Set initial view
            updateView(roleTabs[0].id);
        };

        // --- APPS SCRIPT COMMUNICATION (Mocked fetch for clarity, add retry logic in deployment) ---

        /** Generic handler for Apps Script communication */
        const postData = async (action, data = {}) => {
            clearError();
            if (APPS_SCRIPT_URL === "YOUR_DEPLOYED_APPS_SCRIPT_URL_HERE") {
                displayError("Configuration Error: Please update the APPS_SCRIPT_URL with your actual deployment link.");
                return { success: false, data: null, error: "URL not configured" };
            }

            const payload = { action, role: currentRole, ...data };
            let responseData = { success: false, data: null, error: "Network or server error." };

            toggleLoading(true);
            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    cache: 'no-cache',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP Error: ${response.status}`);
                }

                responseData = await response.json();

                if (!responseData.success) {
                    displayError(`Operation failed: ${responseData.error || 'Unknown error from server.'}`);
                }

            } catch (error) {
                console.error("Fetch failed:", error);
                displayError(`Connection Error: Could not reach the Apps Script. Check the URL and deployment permissions. (${error.message})`);
            } finally {
                toggleLoading(false);
            }
            return responseData;
        };

        // --- CORE APPLICATION LOGIC ---

        /** * Public User: Submits a new ride booking 
         */
        const handleBookingSubmit = async (e) => {
            e.preventDefault();
            const formData = {
                name: document.getElementById('name').value,
                phone: document.getElementById('phone').value,
                pickup: document.getElementById('pickup').value,
                destination: document.getElementById('destination').value,
                notes: document.getElementById('notes').value
            };

            const result = await postData('bookNewRide', formData);

            if (result.success) {
                displayStatus(`Booking submitted successfully! Your tracking ID is: ${result.data.id}`);
                e.target.reset(); // Clear form
            }
        };

        // --- DRIVER VIEW LOGIC ---

        /** * Driver: Fetches and displays their assigned rides 
         */
        const fetchDriverRides = async () => {
            driverRidesList.innerHTML = `<p class="text-center text-gray-500 p-4">${renderIcon('loader-circle', 'w-5 h-5 inline mr-2 animate-spin')} Loading assigned rides...</p>`;
            
            // In a real app, 'data' would contain the driver's ID
            const driverId = activeDriverId; // Using the mock driver ID for demo/testing
            const result = await postData('getDriverRides', { driverId }); 

            if (result.success && result.data && result.data.length > 0) {
                driverRidesList.innerHTML = result.data.map(ride => `
                    <div class="bg-white p-4 rounded-lg border shadow-sm">
                        <p class="font-bold text-gray-700">ID: ${ride.id} - Status: <span class="text-sm font-semibold p-1 rounded-full ${ride.status === 'Completed' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}">${ride.status}</span></p>
                        <p class="text-sm text-gray-500 truncate">From: ${ride.pickup} to ${ride.destination}</p>
                        <p class="text-sm mt-2">Booked by: ${ride.name} (${ride.phone})</p>
                        <div class="flex space-x-2 mt-3">
                            ${ride.status === 'Assigned' ? `<button data-id="${ride.id}" data-status="In Progress" class="update-driver-status btn-primary text-white text-xs py-2 px-3 rounded-lg flex-1">Start Ride</button>` : ''}
                            ${ride.status === 'In Progress' ? `<button data-id="${ride.id}" data-status="Completed" class="update-driver-status btn-secondary text-white text-xs py-2 px-3 rounded-lg flex-1">Complete Ride</button>` : ''}
                        </div>
                    </div>
                `).join('');
                document.querySelectorAll('.update-driver-status').forEach(btn => {
                    btn.addEventListener('click', handleDriverStatusUpdate);
                });
            } else {
                driverRidesList.innerHTML = '<p class="text-center text-gray-500 p-4 border rounded-lg">No assigned rides currently. Check back soon!</p>';
            }
        };

        /**
         * Driver: Handles updating the status of a specific ride.
         */
        const handleDriverStatusUpdate = async (e) => {
            const rideId = e.target.getAttribute('data-id');
            const newStatus = e.target.getAttribute('data-status');

            const result = await postData('updateRideStatus', { rideId, newStatus });

            if (result.success) {
                displayStatus(`Ride ${rideId} status updated to: ${newStatus}`);
                fetchDriverRides(); // Refresh the list
            }
        };


        // --- ADMIN VIEW LOGIC ---

        /** * Admin: Fetches and displays pending bookings 
         */
        const fetchPendingBookings = async () => {
            pendingBookingsList.innerHTML = `<p class="text-center text-gray-500 p-4">${renderIcon('loader-circle', 'w-5 h-5 inline mr-2 animate-spin')} Loading pending bookings...</p>`;
            
            const result = await postData('getPendingBookings'); 

            if (result.success && result.data) {
                pendingBookings = result.data; // Store globally for assignment
                renderPendingBookings();
            } else {
                pendingBookingsList.innerHTML = '<p class="text-center text-gray-500 p-4 border rounded-lg">No new bookings requiring assignment.</p>';
            }
        };

        /** Renders the list of pending bookings */
        const renderPendingBookings = () => {
            if (pendingBookings.length === 0) {
                pendingBookingsList.innerHTML = '<p class="text-center text-gray-500 p-4 border rounded-lg">No new bookings requiring assignment.</p>';
                return;
            }

            pendingBookingsList.innerHTML = pendingBookings.map(ride => `
                <div class="bg-white p-4 rounded-lg border shadow-sm flex justify-between items-center">
                    <div>
                        <p class="font-bold text-gray-700">#${ride.id} - ${ride.pickup}</p>
                        <p class="text-sm text-gray-500">To: ${ride.destination}</p>
                        <p class="text-xs text-gray-400 mt-1">Booked by: ${ride.name}</p>
                    </div>
                    <button data-id="${ride.id}" class="assign-button btn-secondary text-white text-xs py-2 px-3 rounded-lg shadow-md hover:shadow-lg transition">
                        Assign
                        ${renderIcon('chevron-right', 'w-4 h-4 ml-1 inline')}
                    </button>
                </div>
            `).join('');

            document.querySelectorAll('.assign-button').forEach(btn => {
                btn.addEventListener('click', handleAssignBooking);
            });
        };

        /**
         * Admin: Handles assigning a booking to the currently selected driver.
         */
        const handleAssignBooking = async (e) => {
            const rideId = e.target.getAttribute('data-id');
            const driverId = driverSelector.value;
            const driverName = driverSelector.options[driverSelector.selectedIndex].text;

            if (!driverId) {
                displayError("Please select a driver from the list before assigning.");
                return;
            }

            const result = await postData('assignBooking', { rideId, driverId, driverName });

            if (result.success) {
                displayStatus(`Booking ${rideId} assigned to ${driverName} (${driverId})`);
                // Remove the assigned ride from the local list and re-render
                pendingBookings = pendingBookings.filter(ride => ride.id !== rideId);
                renderPendingBookings();
            }
        };

        // --- INITIALIZATION ---

        const initApp = () => {
            // 1. Populate Driver Selector (Admin View)
            MOCK_DRIVERS.forEach(driver => {
                const option = document.createElement('option');
                option.value = driver.id;
                option.textContent = driver.name;
                driverSelector.appendChild(option);
            });
            driverSelector.addEventListener('change', (e) => activeDriverId = e.target.value);
            // Pre-select the first driver for demo
            if (MOCK_DRIVERS.length > 0) {
                 driverSelector.value = MOCK_DRIVERS[0].id;
                 activeDriverId = MOCK_DRIVERS[0].id;
            }


            // 2. Load Role and Setup Tabs
            roleSelector.value = currentRole;
            setupTabs();
            scriptUrlInput.value = APPS_SCRIPT_URL; // Show the user their URL setting

            // 3. Attach Event Listeners
            if (document.getElementById('bookingForm')) {
                document.getElementById('bookingForm').addEventListener('submit', handleBookingSubmit);
            }
            if (settingsButton) {
                settingsButton.addEventListener('click', () => updateView('settings-view'));
            }
            if (document.getElementById('saveSettingsButton')) {
                document.getElementById('saveSettingsButton').addEventListener('click', () => {
                    const newRole = roleSelector.value;
                    localStorage.setItem('userRole', newRole);
                    currentRole = newRole;
                    setupTabs();
                    displayStatus(`Role set to: ${newRole.charAt(0).toUpperCase() + newRole.slice(1)}`);
                });
            }
            
            // 4. Initial Data Load based on Role
            if (currentRole === 'driver') {
                fetchDriverRides();
            } else if (currentRole === 'admin') {
                fetchPendingBookings();
            }
        };

        // Initialize the application when the DOM is ready
        window.addEventListener('load', initApp);
    </script>
</body>
</html>
